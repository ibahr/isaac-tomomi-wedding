<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wedding of Isaac & Tomomi</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Yellowtail&family=Noto+Sans+JP&family=Rampart+One&family=Yuji+Boku&display=swap" rel="stylesheet">
</head>
<body>
    <header class="hero">
        <div class="overlay"></div>
        <div class="hero-text">
            <h1>Isaac & Tomomi's Wedding<br><span class="jp-text-header">アイザックと友美の結婚式</span></h1>
            <p>April 12, 2025<br><span class="jp-text"></span></p>
        </div>
    </header>

    <section class="imageband">
        <div></div>
    </section>

    <section class="about">
        <h2>About Us<br><span class="jp-text">私たちについて</span></h2>
        <p>We can't wait to celebrate our special day with you! Join us for an unforgettable event at Atsuta Jingu and Hilton Nagoya.<br><span class="jp-text">私たちはこの特別な日を皆さんと一緒に祝えるのを楽しみにしています！熱田神宮とヒルトン名古屋での忘れられないイベントに参加してください。</span></p>
    </section>

    <section class="details">
        <h2>Wedding Details<br><span class="jp-text">結婚式の詳細</span></h2>
        <div class="details-content">
            <div class="detail">
                <h3>Ceremony<br><span class="jp-text">結婚式</span></h3>
                <p>Atsuta Jingu, Nagoya<br><span class="jp-text">熱田神宮、名古屋</span></p>
            </div>
            <div class="detail">
                <h3>Reception<br><span class="jp-text">披露宴</span></h3>
                <p>Hilton Nagoya, 105 Ballroom<br><span class="jp-text">ヒルトン名古屋、105 ボールルーム</span></p>
            </div>
        </div>
    </section>

    <section class="guest-rsvp">
        <h2>RSVP<span id="guest-name"></span><br><span id="jpn-guest-name" class="jp-text">お返事お待ちしております！</span></h2>
        <p id="custom-message"></p>

        <form id="rsvp-form">
            <input type="text" id="guest" placeholder="Enter your code ・ コードを入力" required>
            <button type="button" onclick="loadGuestInfo()">Load Guest Info</button>

            <!-- Individual Guest RSVP Section -->
            <div id="guest-list-section" style="display:none;">
                <h3><div id="guest-list-text">Please confirm attendance for each guest:</div></h3>
                <div id="guest-list"></div>
            </div>

            <!-- Plus One Section -->
            <div id="plus-one-section" style="display:none;">
                <h3>Will you bring a plus one?</h3>
                <label>
                    <input type="radio" name="plusone" value="yes"> Yes
                </label>
                <label>
                    <input type="radio" name="plusone" value="no"> No
                </label>

                <div id="plus-one-name-section" style="display:none;">
                    <input type="text" id="plus-one-name" placeholder="Enter the name of your plus one">
                </div>
            </div>

            <div id="submit-section" style="display:none;">
                <button type="submit">Submit RSVP</button>
            </div>
        </form>
    </section>

    <script type="module">
        // Import Firebase and Firestore functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBQ3giOhEChsj8oziRaTGeITm7bT8bxfno",
            authDomain: "wedding-2193a.firebaseapp.com",
            projectId: "wedding-2193a",
            storageBucket: "wedding-2193a.appspot.com",
            messagingSenderId: "856129939537",
            appId: "1:856129939537:web:0c7f5a0ee410197ab67070"
        };

        // Initialize Firebase and Firestore
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        //load guest info function
        async function loadGuestInfo() {
            console.log("Load Guest Info button clicked");
            
            const guestCode = document.getElementById('guest').value.toLowerCase();
            console.log("Guest code entered:", guestCode);
            
            const guestDocRef = doc(db, "guests", guestCode);

            try {
                const guestDoc = await getDoc(guestDocRef);
                if (guestDoc.exists()) {
                    const guestInfo = guestDoc.data();
                    console.log("Guest data fetched:", guestInfo);

                    // Ensure each element is defined before accessing its properties
                    const guestNameElement = document.getElementById('guest-name');
                    const jpnNameElement = document.getElementById('jpn-guest-name')
                    const customMessageElement = document.getElementById('custom-message');
                    const rsvpSection = document.getElementById('rsvp-section');
                    const guestListContainer = document.getElementById('guest-list');
                    const guestListSection = document.getElementById('guest-list-section');
                    const guestListText = document.getElementById('guest-list-text');
                    const plusOneSection = document.getElementById('plus-one-section');
                    const submitSection = document.getElementById('submit-section');

                    if (guestNameElement) guestNameElement.textContent = ' for ' + guestInfo.name;
                    if (jpnNameElement) jpnNameElement.textContent = guestInfo.name + 'のお返事';
                    if (customMessageElement) customMessageElement.textContent = guestInfo.message;
                    if (rsvpSection) rsvpSection.style.display = 'block';
                    if (guestListText && guestInfo.lang === 'jpn') guestListText.textContent = "どちらかを選んでください:";
                    if (guestListText && guestInfo.lang === 'eng') guestListText.textContent = "Please confirm attendance for each guest:";

                    if (guestListContainer) guestListContainer.innerHTML = ''; // Clear previous content

                    // Display individual RSVPs for each guest in the group
                    if (guestInfo.guestNames && guestListContainer && guestListSection) {
                        guestInfo.guestNames.forEach((name, index) => {
                            const individualRsvpDiv = document.createElement('div');
                            individualRsvpDiv.classList.add('individual-rsvp');

                            const nameHeader = document.createElement('h4');
                            nameHeader.textContent = name;
                            individualRsvpDiv.appendChild(nameHeader);

                            // Ceremony RSVP options
                            const ceremonyLabel = document.createElement('div');
                            ceremonyLabel.textContent = guestInfo.lang === 'jpn' ? "結婚式の出席" : "Ceremony Attendance";
                            individualRsvpDiv.appendChild(ceremonyLabel);

                            const ceremonyYesLabel = document.createElement('label');
                            const ceremonyYesRadio = document.createElement('input');
                            ceremonyYesRadio.type = 'radio';
                            ceremonyYesRadio.name = `ceremony_attending_${index}`;
                            ceremonyYesRadio.value = 'yes';
                            ceremonyYesRadio.required = true;
                            ceremonyYesLabel.appendChild(ceremonyYesRadio);
                            ceremonyYesLabel.appendChild(document.createTextNode(guestInfo.lang === 'jpn' ? ' 出席 ' : ' Yes  '));

                            const ceremonyNoLabel = document.createElement('label');
                            const ceremonyNoRadio = document.createElement('input');
                            ceremonyNoRadio.type = 'radio';
                            ceremonyNoRadio.name = `ceremony_attending_${index}`;
                            ceremonyNoRadio.value = 'no';
                            ceremonyNoRadio.required = true;
                            ceremonyNoLabel.appendChild(ceremonyNoRadio);
                            ceremonyNoLabel.appendChild(document.createTextNode(guestInfo.lang === 'jpn' ? ' 欠席 ' : ' No '));

                            individualRsvpDiv.appendChild(ceremonyYesLabel);
                            individualRsvpDiv.appendChild(ceremonyNoLabel);

                            // Reception RSVP options
                            const receptionLabel = document.createElement('div');
                            receptionLabel.textContent = guestInfo.lang === 'jpn' ? "披露宴の出席" : "Reception Attendance";
                            individualRsvpDiv.appendChild(receptionLabel);

                            const receptionYesLabel = document.createElement('label');
                            const receptionYesRadio = document.createElement('input');
                            receptionYesRadio.type = 'radio';
                            receptionYesRadio.name = `reception_attending_${index}`;
                            receptionYesRadio.value = 'yes';
                            receptionYesRadio.required = true;
                            receptionYesLabel.appendChild(receptionYesRadio);
                            receptionYesLabel.appendChild(document.createTextNode(guestInfo.lang === 'jpn' ? ' 出席 ' : ' Yes  '));

                            const receptionNoLabel = document.createElement('label');
                            const receptionNoRadio = document.createElement('input');
                            receptionNoRadio.type = 'radio';
                            receptionNoRadio.name = `reception_attending_${index}`;
                            receptionNoRadio.value = 'no';
                            receptionNoRadio.required = true;
                            receptionNoLabel.appendChild(receptionNoRadio);
                            receptionNoLabel.appendChild(document.createTextNode(guestInfo.lang === 'jpn' ? ' 欠席 ' : ' No '));

                            individualRsvpDiv.appendChild(receptionYesLabel);
                            individualRsvpDiv.appendChild(receptionNoLabel);

                            // Pre-fill RSVP if response exists
                            if (guestInfo.rsvp && guestInfo.rsvp[name]) {
                                if (guestInfo.rsvp[name].ceremony === 'yes') ceremonyYesRadio.checked = true;
                                else if (guestInfo.rsvp[name].ceremony === 'no') ceremonyNoRadio.checked = true;

                                if (guestInfo.rsvp[name].reception === 'yes') receptionYesRadio.checked = true;
                                else if (guestInfo.rsvp[name].reception === 'no') receptionNoRadio.checked = true;
                            }

                            guestListContainer.appendChild(individualRsvpDiv);
                        });

                        guestListSection.style.display = 'block';
                    }

                    // Show plus one section if applicable
                    if (plusOneSection) {
                        plusOneSection.style.display = guestInfo.canBringPlusOne ? 'block' : 'none';
                    }

                    submitSection.style.display = 'block';

                } else {
                    console.log('Guest document does not exist');
                    alert('Guest not found. Please enter the correct code.');
                }
            } catch (error) {
                console.error("Error retrieving guest info:", error);
            }
        }

        // Submit RSVP responses to Firestore
        document.getElementById('rsvp-form').addEventListener('submit', async function(event) {
            event.preventDefault();

            const guestCode = document.getElementById('guest').value.toLowerCase();
            const guestDocRef = doc(db, "guests", guestCode);
            const responses = {};

            // Capture responses for each guest in the group
            const guestListSection = document.getElementById('guest-list-section');
            const guestDivs = guestListSection.querySelectorAll('.individual-rsvp');
            let allValid = true;

            guestDivs.forEach((div, index) => {
                const guestName = div.querySelector('h4').textContent;

                // Ceremony response
                const ceremonyResponse = div.querySelector(`input[name="ceremony_attending_${index}"]:checked`);
                const receptionResponse = div.querySelector(`input[name="reception_attending_${index}"]:checked`);

                // Validate that both ceremony and reception responses are selected
                if (!ceremonyResponse || !receptionResponse) {
                    allValid = false;
                }

                responses[guestName] = {
                    ceremony: ceremonyResponse ? ceremonyResponse.value : null,
                    reception: receptionResponse ? receptionResponse.value : null
                };
            });
            
            // Check if all required responses are valid
            if (!allValid || Object.keys(responses).length === 0) {
                alert("Error submitting RSVP");
                return;
            }

            // Update Firestore with responses
            try {
                await updateDoc(guestDocRef, { rsvp: responses });
                alert('RSVP Submitted!');
            } catch (error) {
                console.error("Error submitting RSVP:", error);
            }
        });
        window.loadGuestInfo = loadGuestInfo;
    </script>

    <footer>
        <p>&copy; 2025 Isaac & Tomomi - Thank you for being part of our journey!<br><span class="jp-text">アイザックとともみの結婚式に参加していただきありがとうございます！</span></p>
    </footer>
</body>
</html>
